image: docker:latest  # Usaremos Docker para los builds

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_HOST: unix:///var/run/docker.sock
  IMAGE_NAME: "192.168.74.132:5050/adrian-manuel/spvending-managment:latest"  # Nombre de la imagen en GitLab Registry
  COMPOSE_PROJECT_NAME: spvending-managment
  REGISTRY_URL: "192.168.74.132:5050"
stages:
  - build
  - deploy

build_image:
  stage: build
  tags:
    - build
  script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
    - docker-compose -f docker-compose.yml build  # Usamos Docker Compose para construir la imagen
    - docker tag spvending-api-image $IMAGE_NAME
    - docker push $IMAGE_NAME
  only:
    - main
deploy_app:
  stage: deploy
  tags:
    - deploy  # Tag del runner local
  script:
    - $env:DOCKER_HOST = "npipe:////./pipe/docker_cli"
    - docker login -u "$env:CI_REGISTRY_USER" -p "$env:CI_REGISTRY_PASSWORD" "$env:REGISTRY_URL"
    - docker pull "$env:192.168.74.132:5050/adrian-manuel/spvending-managment:latest"
    - docker-compose -f docker-compose.deploy.yml down
    - docker-compose -f docker-compose.deploy.yml up -d
  only:
    - main