image: docker:24.0.6  # Versión específica para mayor reproducibilidad

variables:
  DOCKER_HOST: "npipe:////./pipe/docker_engine"  # Configuración correcta para Windows
  IMAGE_NAME: "192.168.74.132:5050/adrian-manuel/spvending-managment:latest"
  REGISTRY_URL: "192.168.74.132:5050"
  COMPOSE_PROJECT_NAME: "spvending-managment"
  DOCKER_BUILDKIT: 1  # Habilita BuildKit para builds más rápidos

stages:
  - build
  - deploy

build_image:
  stage: build
  tags:
    - build
  before_script:
    - echo "Iniciando proceso de construcción de la imagen..."
    - docker --version
    - docker-compose --version
  script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" -password-stdin $REGISTRY_URL
    - docker-compose -f docker-compose.yml build --no-cache --pull
    - docker tag spvending-api-image $IMAGE_NAME
    - docker push $IMAGE_NAME
  after_script:
    - docker logout $REGISTRY_URL
  only:
    - main
  timeout: 30 minutes  # Tiempo máximo para el stage de build

deploy_app:
  stage: deploy
  tags:
    - deploy
  before_script:
    - echo "Preparando despliegue en producción..."
    - docker --version
    - docker-compose --version
  script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $REGISTRY_URL
    - docker pull $IMAGE_NAME || echo "Advertencia:Falló el pull inicial, continuando con imagen local"
    - docker-compose -f docker-compose.deploy.yml down --remove-orphans
    - docker-compose -f docker-compose.deploy.yml up -d --force-recreate
    - docker system prune -f  # Limpieza de recursos no utilizados
  after_script:
    - docker logout $REGISTRY_URL
    - docker ps -a  # Muestra el estado de los contenedores
  only:
    - main
  timeout: 20 minutes  # Tiempo máximo para el stage de deploy