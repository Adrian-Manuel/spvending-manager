image: docker:latest
services:
  - docker:dind

variables:
  DOCKER_DRIVER: overlay2

stages:
  - build
  - dockerized
  - deploy

# 1. Compilar la aplicaci√≥n
build-app:
  image: eclipse-temurin:22-jdk
  stage: build
  tags:
    - build
  script:
    - mvn clean package -DskipTests
  artifacts:
    paths:
      - target/*.jar

# 3. Construir la imagen Docker localmente
docker-build:
  stage: dockerized
  tags:
    - docker
  script:
    - docker build -t spvending-api-image .
    - docker images

# 4. Despliegue local usando Docker Compose
deploy-local:
  stage: deploy
  tags:
    - deploy
  script:
    - docker-compose down || true
    - docker-compose up -d --build
    - docker-compose ps
  only:
    - main
